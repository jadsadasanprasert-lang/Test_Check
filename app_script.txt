// ===== Config =====
const SHEET_ID = '1vua0b46ZMEf4uDEAzf8Wb8AaDKrYUnRyLR700_UoC_I';
const ATTENDANCE_SHEET_NAME = 'Check-In';
const EMPLOYEE_SHEET_NAME = 'Employees';
const HR_SHEET_NAME = 'HR'; // ‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ï HR
const DRIVE_FOLDER_ID = '1fItGmdoc7aTJZmAOyCY1ol70M0iRy_Hh'; // ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏ô Google Drive

// ===== Utilities =====
function createJsonResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

function getSheetDataAsObjects(sheet) {
  if (!sheet) return [];
  const lastCol = sheet.getLastColumn();
  const lastRow = sheet.getLastRow();

  // ‡∏ñ‡πâ‡∏≤‡∏ä‡∏µ‡∏ï‡∏ß‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡∏´‡∏±‡∏ß (‡πÅ‡∏ñ‡∏ß 1) ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ï‡πà‡∏≠
  if (lastRow < 2) return []; 

const data = sheet.getRange(1, 1, lastRow, lastCol).getValues();

  const headers = data.shift();
  return data.map((row) => {
    const obj = {};
    headers.forEach((header, i) => {
      const v = row[i];

      if (v instanceof Date) {
        if (header === 'checkIn' || header === 'checkOut') {
          obj[header] = Utilities.formatDate(v, 'GMT+7', 'HH:mm');
        } else if (header === 'date') {
          obj[header] = Utilities.formatDate(v, 'GMT+7', 'yyyy-MM-dd');
        } else {
          obj[header] = v.toISOString();
        }
      } else {
        obj[header] = v;
      }
    });
    return obj;
  });
}

/**
 * ‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡∏´‡∏≤‡∏Å‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ (‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢)
 */
/**
 * ‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡∏´‡∏≤‡∏Å‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ (‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢)
 * * [FIXED] - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô headers ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ 'filter' ‡∏•‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á
 * ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (Column Mismatch)
 */
function ensureHeaders(sheet, requiredHeaders) {
  let headers;
  
  if (sheet.getLastRow() === 0) {
    // --- 1. ‡∏Å‡∏£‡∏ì‡∏µ‡∏ä‡∏µ‡∏ï‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ ---
    headers = [];
  } else {
    // --- 2. ‡∏Å‡∏£‡∏ì‡∏µ‡∏ä‡∏µ‡∏ï‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
    // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏´‡∏±‡∏ß‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1 ‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà filter
    const lastCol = Math.max(1, sheet.getLastColumn());
    headers = sheet.getRange(1, 1, 1, lastCol).getValues()[0];
    
    // [FIX] ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ß‡πà‡∏≤‡∏á" ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà "‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢" ‡∏≠‡∏≠‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà "‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á"
    while (headers.length > 0 && String(headers[headers.length - 1]).trim() === '') {
      headers.pop();
    }
  }

  // --- 3. (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ‡πÄ‡∏ï‡∏¥‡∏° header ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏õ ---
  let hasNewHeader = false;
  requiredHeaders.forEach(h => {
    if (headers.indexOf(h) === -1) {
      headers.push(h);
      hasNewHeader = true; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà
    }
  });

  // --- 4. (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô headers ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ä‡∏µ‡∏ï ---
  // [FIX] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
  // ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ï‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å (headers.length > 0)
  if (hasNewHeader || sheet.getLastRow() === 0) {
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  }
  
  return headers;
}

// --- ‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ] (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å script.js) ---
// ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ doPost (action: delete) ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
function normalizeDateStr(input) {
  if (!input) return '';
  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
  if (/^\d{4}-\d{2}-\d{2}$/.test(input)) return input;

  // MM/DD/YYYY ‡∏´‡∏£‡∏∑‡∏≠ DD/MM/YYYY
  const m = String(input).match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (m) {
    let a = parseInt(m[1],10), b = parseInt(m[2],10), y = m[3];
    if (y.length === 2) y = '20' + y;
    // ‡∏ñ‡πâ‡∏≤ a>12 ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô DD/MM/YYYY
    let month = (a > 12) ? b : a;
    let day   = (a > 12) ? a : b;
    return `${y}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
  }

  // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
  try {
    const d = new Date(input);
    if (!isNaN(d)) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
  } catch (e) {}
  return '';
}
// --- ‚ú® [‡∏à‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°] ---
// ===== GET: ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö =====
function doGet(e) {
  try {
    const book = SpreadsheetApp.openById(SHEET_ID);
    const attendanceSheet = book.getSheetByName(ATTENDANCE_SHEET_NAME);
    const employeeSheet = book.getSheetByName(EMPLOYEE_SHEET_NAME);
    const hrSheet = book.getSheetByName(HR_SHEET_NAME); // ‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°]

    const attendanceData = getSheetDataAsObjects(attendanceSheet);
    const employeeData = getSheetDataAsObjects(employeeSheet);
    const hrData = getSheetDataAsObjects(hrSheet); // ‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• HR

    return createJsonResponse({
      status: 'success',
      attendance: attendanceData,
      employees: employeeData,
      hr_users: hrData // ‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• HR ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
    });
  } catch (err) {
    return createJsonResponse({ status: 'error', message: err.message });
  }
}

/**
 * ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Drive ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∑‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå
 * @param {string} base64Data dataURL (data:image/jpeg;base64,xxxx)
 * @param {string} fileName   EMP001_20251107_0901.jpg
 */
function uploadPhotoToDrive(base64Data, fileName) {
  try {
    const base64String = base64Data.split(',')[1];
    const blob = Utilities.newBlob(Utilities.base64Decode(base64String), 'image/jpeg', fileName);
    const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    return file.getUrl();
  } catch (error) {
    Logger.log('Upload error: ' + error.message);
    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ: ' + error.message);
  }
}

// ===== POST: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Check-In/Out =====
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const book = SpreadsheetApp.openById(SHEET_ID);
    const sheet = book.getSheetByName(ATTENDANCE_SHEET_NAME);

    // --- ‚ú® [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] 1. ‡πÄ‡∏û‡∏¥‡πà‡∏° Headers ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Check-Out ---
    const REQUIRED = [
      'empId','name','department','position','date','checkIn','checkOut',
      'workHours','otHours','totalHours','totalHours_HHMM','status',
      // Check-In (‡πÄ‡∏î‡∏¥‡∏°)
      'type','reason','lat','lon','distance','photoUrl',
      // Check-Out (‡πÉ‡∏´‡∏°‡πà)
      'checkOut_type', 'checkOut_reason', 'checkOut_lat', 
      'checkOut_lon', 'checkOut_distance', 'checkOut_photoUrl'
    ];
    let headers = ensureHeaders(sheet, REQUIRED);

    // ----- Check-In (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) -----
    if (data.action === 'checkIn') {
      let photoUrl = '';
      if (data.photoData) {
        const fileName = `${data.empId}_${(data.date || '').replace(/-/g,'')}_${(data.checkIn || '').replace(/:/g,'')}_CI.jpg`;
        photoUrl = uploadPhotoToDrive(data.photoData, fileName);
      }

      const newRow = headers.map(header => {
        if (header === 'checkIn' && data.checkIn) return `'${data.checkIn}`;
        if (header === 'photoUrl') return photoUrl;
        if (header === 'type') {
          const onsite = (data.onsite !== false);
          return onsite ? '‡πÉ‡∏ô‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®' : '‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà';
        }
        if (header === 'reason') return data.offsiteNote || '';
        if (header === 'lat') return (data.locationLat ?? '');
        if (header === 'lon') return (data.locationLon ?? '');
        if (header === 'distance') return (data.locationDistanceM ?? '');

        // ‡πÉ‡∏™‡πà null ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á checkOut (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏¢‡∏∞)
        if (header.startsWith('checkOut_')) return null;

        return (data.hasOwnProperty(header) ? data[header] : null);
      });
      if (headers.indexOf('checkOut') > -1)   newRow[headers.indexOf('checkOut')] = null;
      if (headers.indexOf('workHours') > -1)  newRow[headers.indexOf('workHours')] = 0;
      if (headers.indexOf('otHours') > -1)    newRow[headers.indexOf('otHours')] = 0;
      if (headers.indexOf('totalHours') > -1) newRow[headers.indexOf('totalHours')] = 0;

      sheet.appendRow(newRow);

      return createJsonResponse({
        status: 'success',
        message: 'Check-in successful',
        data: { ...data, photoUrl }
      });
    }

    // --- ‚ú® [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î Check-Out ---
    if (data.action === 'checkOut') {
      
      // 2.1 ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ Check-Out (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      let checkOutPhotoUrl = '';
      if (data.checkOut_photoData) {
        const fileName = `${data.empId}_${(data.date || '').replace(/-/g,'')}_${(data.checkOut || '').replace(/:/g,'')}_CO.jpg`; // ‡πÄ‡∏ï‡∏¥‡∏° _CO (Check-Out)
        checkOutPhotoUrl = uploadPhotoToDrive(data.checkOut_photoData, fileName);
      }

      // 2.2 ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
      const all = sheet.getDataRange().getValues();
      headers = all.shift(); 

      const empIdCol = headers.indexOf('empId');
      const dateCol  = headers.indexOf('date');
      let rowToUpdate = -1;
      
      for (let i = 0; i < all.length; i++) {
        const r = all[i];
        const rowDate = (r[dateCol] instanceof Date)
          ? Utilities.formatDate(r[dateCol], 'GMT+7', 'yyyy-MM-dd')
          : r[dateCol];
        if (String(r[empIdCol]) === String(data.empId) && rowDate === data.date) {
          rowToUpdate = i + 2; // +1 for 1-based index, +1 for header row
          break;
        }
      }

      if (rowToUpdate === -1) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ñ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Check-Out');

      // 2.3 ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡∏°‡πà)
      const coCol    = headers.indexOf('checkOut');
      const whCol    = headers.indexOf('workHours'); 
      const otCol    = headers.indexOf('otHours');
      const totCol   = headers.indexOf('totalHours'); 
      const totHHMMCol = headers.indexOf('totalHours_HHMM');
      // (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà)
      const coTypeCol     = headers.indexOf('checkOut_type');
      const coReasonCol   = headers.indexOf('checkOut_reason');
      const coLatCol      = headers.indexOf('checkOut_lat');
      const coLonCol      = headers.indexOf('checkOut_lon');
      const coDistCol     = headers.indexOf('checkOut_distance');
      const coPhotoCol    = headers.indexOf('checkOut_photoUrl');

      // 2.4 ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Set Values)
      
      // (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤: ‡πÄ‡∏ß‡∏•‡∏≤)
      if (coCol > -1)  sheet.getRange(rowToUpdate, coCol + 1).setValue(`'${data.checkOut}`); 
      if (whCol > -1)  sheet.getRange(rowToUpdate, whCol + 1).setValue(data.workHours || 0); 
      if (otCol > -1)  sheet.getRange(rowToUpdate, otCol + 1).setValue(data.otHours || 0); 
      if (totCol > -1) sheet.getRange(rowToUpdate, totCol + 1).setValue(data.totalHours || 0); 
      if (totHHMMCol > -1) sheet.getRange(rowToUpdate, totHHMMCol + 1).setValue(data.totalHours_HHMM || ''); // üëà ‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ]

      // (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà: ‡∏û‡∏¥‡∏Å‡∏±‡∏î, ‡∏£‡∏π‡∏õ)
      if (coTypeCol > -1) {
        const onsite = (data.checkOut_onsite !== false);
        sheet.getRange(rowToUpdate, coTypeCol + 1).setValue(onsite ? '‡πÉ‡∏ô‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®' : '‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà');
      }
      if (coReasonCol > -1) sheet.getRange(rowToUpdate, coReasonCol + 1).setValue(data.checkOut_offsiteNote || '');
if (coLatCol > -1)    sheet.getRange(rowToUpdate, coLatCol + 1).setValue(data.checkOut_lat ?? '');
if (coLonCol > -1)    sheet.getRange(rowToUpdate, coLonCol + 1).setValue(data.checkOut_lon ?? '');
if (coDistCol > -1)   sheet.getRange(rowToUpdate, coDistCol + 1).setValue(data.checkOut_distance ?? '');
if (coPhotoCol > -1)  sheet.getRange(rowToUpdate, coPhotoCol + 1).setValue(checkOutPhotoUrl);

      return createJsonResponse({
        status: 'success',
        message: 'Check-out successful',
        data: {...data, checkOut_photoUrl: checkOutPhotoUrl} // ‡∏™‡πà‡∏á URL ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ frontend
      });
    }

    if (data.action === 'edit') {
      
      // 3.1 ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô checkOut)
      const all = sheet.getDataRange().getValues();
      headers = all.shift(); // ‡πÉ‡∏ä‡πâ headers ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï

      const empIdCol = headers.indexOf('empId');
      const dateCol  = headers.indexOf('date');
      let rowToUpdate = -1;

      for (let i = 0; i < all.length; i++) {
        const r = all[i];
        const rowDate = (r[dateCol] instanceof Date)
          ? Utilities.formatDate(r[dateCol], 'GMT+7', 'yyyy-MM-dd')
          : r[dateCol];
        
        // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏ä‡πâ normalizeDateStr ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
        const normalizedRowDate = normalizeDateStr(rowDate);
        const normalizedDataDate = normalizeDateStr(data.date);

        if (String(r[empIdCol]) === String(data.empId) && normalizedRowDate === normalizedDataDate) {
          rowToUpdate = i + 2; // +1 for 1-based index, +1 for header row
          break;
        }
      }

      if (rowToUpdate === -1) {
        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ñ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (Edit) (empId: ' + data.empId + ', date: ' + data.date + ')');
      }

      // 3.2 ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏Å‡πâ)
      const ciCol      = headers.indexOf('checkIn');
      const coCol      = headers.indexOf('checkOut');
      const statusCol  = headers.indexOf('status');
      const whCol      = headers.indexOf('workHours'); 
      const otCol      = headers.indexOf('otHours');
      const totCol     = headers.indexOf('totalHours');
      const totHHMMCol = headers.indexOf('totalHours_HHMM');
      
      // 3.3 ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Set Values)
      // (‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤)

      if (ciCol > -1) sheet.getRange(rowToUpdate, ciCol + 1).setValue(data.checkIn ? `'${data.checkIn}` : null);
      if (coCol > -1) sheet.getRange(rowToUpdate, coCol + 1).setValue(data.checkOut ? `'${data.checkOut}` : null);
      if (statusCol > -1) sheet.getRange(rowToUpdate, statusCol + 1).setValue(data.status || null);
      
      if (whCol > -1)  sheet.getRange(rowToUpdate, whCol + 1).setValue(data.workHours || 0);
      if (otCol > -1)  sheet.getRange(rowToUpdate, otCol + 1).setValue(data.otHours || 0);
      if (totCol > -1) sheet.getRange(rowToUpdate, totCol + 1).setValue(data.totalHours || 0); 
      if (totHHMMCol > -1) sheet.getRange(rowToUpdate, totHHMMCol + 1).setValue(data.totalHours_HHMM || '');

      return createJsonResponse({
        status: 'success',
        message: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        data: data // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ frontend
      });
    }
    // --- ‚ú® [‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°] ---

    // --- ‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Delete) ---
    if (data.action === 'delete') {
      
      // 3.1 ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö
      const all = sheet.getDataRange().getValues();
      const localHeaders = all.shift(); // ‡πÉ‡∏ä‡πâ headers ‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô
      
      const empIdCol = localHeaders.indexOf('empId');
      const dateCol  = localHeaders.indexOf('date');
      let rowToDelete = -1; // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ index ‡πÉ‡∏ô array (0-based)

      for (let i = 0; i < all.length; i++) {
        const r = all[i];
        const rowDate = (r[dateCol] instanceof Date)
          ? Utilities.formatDate(r[dateCol], 'GMT+7', 'yyyy-MM-dd')
          : r[dateCol]; // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏ä‡πâ r[dateCol] ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Date
        
        // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö normalizeDateStr ‡∏î‡πâ‡∏ß‡∏¢
        const normalizedRowDate = normalizeDateStr(rowDate);
        const normalizedDataDate = normalizeDateStr(data.date);

        if (String(r[empIdCol]) === String(data.empId) && normalizedRowDate === normalizedDataDate) {
          rowToDelete = i;
          break;
        }
      }

      if (rowToDelete === -1) {
        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö (empId: ' + data.empId + ', date: ' + data.date + ')');
      }

      // 3.2 ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß
      // (‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï‡∏à‡∏£‡∏¥‡∏á = index + 2 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ array 0-based ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡πÅ‡∏ñ‡∏ß header)
      sheet.deleteRow(rowToDelete + 2); 

      return createJsonResponse({
        status: 'success',
        message: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'
      });
    }
    // --- ‚ú® [‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°] ---
  // --- ‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] 4. ‡∏£‡∏∞‡∏ö‡∏ö Login ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å Sheet ---
    if (data.action === 'login') {
      const sheet = book.getSheetByName(HR_SHEET_NAME); // ‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏µ‡∏ï HR
      const allUsers = getSheetDataAsObjects(sheet);    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Object (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ header: username, password, role, name)
      
      // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ user ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
      const foundUser = allUsers.find(u => 
        String(u.username) === String(data.username) && 
        String(u.password) === String(data.password)
      );

      if (foundUser) {
        return createJsonResponse({
          status: 'success',
          message: 'Login successful',
          data: {
            role: foundUser.role,  // ‡∏™‡πà‡∏á role ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ (manager ‡∏´‡∏£‡∏∑‡∏≠ hr)
            name: foundUser.name   // ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
          }
        });
      } else {
        return createJsonResponse({
          status: 'error',
          message: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
        });
      }
    }
    // --- ‚ú® [‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°] ---
    // --- ‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] 5. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Change Credentials) ---
    if (data.action === 'changeCredentials') {
      const sheet = book.getSheetByName(HR_SHEET_NAME);
      const allUsers = sheet.getDataRange().getValues(); // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö (‡∏£‡∏ß‡∏° Header)
      
      // ‡∏´‡∏≤ Index ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
      const headers = allUsers[0];
      const userColIndex = headers.indexOf('username');
      const passColIndex = headers.indexOf('password');
      const nameColIndex = headers.indexOf('name');
      
      let userRowIndex = -1;

      // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà
      for (let i = 1; i < allUsers.length; i++) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Username ‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡∏∞ Password ‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)
        if (String(allUsers[i][userColIndex]) === String(data.currentUsername) && 
            String(allUsers[i][passColIndex]) === String(data.oldPassword)) {
          userRowIndex = i + 1; // +1 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ index ‡πÄ‡∏£‡∏¥‡πà‡∏° 0 ‡πÅ‡∏ï‡πà‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô sheet ‡πÄ‡∏£‡∏¥‡πà‡∏° 1
          break;
        }
      }

      if (userRowIndex > -1) {
        // ‡πÄ‡∏à‡∏≠‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á -> ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Username ‡πÉ‡∏´‡∏°‡πà
        sheet.getRange(userRowIndex, userColIndex + 1).setValue(data.newUsername);
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Password ‡πÉ‡∏´‡∏°‡πà
        sheet.getRange(userRowIndex, passColIndex + 1).setValue(data.newPassword);
        // ‚ú® [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Name (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏°‡∏≤)
        if (nameColIndex > -1 && data.newName) {
           sheet.getRange(userRowIndex, nameColIndex + 1).setValue(data.newName);
        }

        return createJsonResponse({
          status: 'success',
          message: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
        });
      } else {
        return createJsonResponse({
          status: 'error',
          message: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'
        });
      }
    }
    // --- ‚ú® [‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°] ---
    throw new Error('Invalid action.');
  } catch (error) {
    return createJsonResponse({ status: 'error', message: error.message });
  }

  
}

// ===== LINE NOTIFICATION FUNCTIONS =====
// (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏¢‡πá‡∏ô)

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÇ‡∏î‡∏¢ Trigger
 * (‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏ï‡∏±‡πâ‡∏á Trigger ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ)
 */
function sendCheckOutReminder() {
  try {
    // 1. ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á
    const message = '‡πÅ‡∏à‡πâ‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô! ‚è∞\n‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏ß‡∏•‡∏≤ 18:00 ‡∏ô. ‡πÅ‡∏•‡πâ‡∏ß ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏° Check-Out ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö WC_Check-In ‡∏Å‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö';
    
    // 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á LINE
    sendLineMessage(message);
    
  } catch (e) {
    Logger.log('Error in sendCheckOutReminder: ' + e.message);
  }
}

/**
 * [‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Push Message ‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE
 * ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Push (1 ‡∏Ñ‡∏ô) ‡πÄ‡∏õ‡πá‡∏ô Multicast (‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô)
 * @param {string} message ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á
 */
function sendLineMessage(message) {
  
  // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Script Properties
  const properties = PropertiesService.getScriptProperties();
  const CHANNEL_TOKEN = properties.getProperty('LINE_CHANNEL_TOKEN');
  const idString = properties.getProperty('LINE_TO_ID'); // üëà ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ","

  // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  if (!CHANNEL_TOKEN || !idString) {
    Logger.log('‚ùå Error: LINE_CHANNEL_TOKEN or LINE_TO_ID is not set in Script Properties.');
    return;
  }

  // 3. [‡πÉ‡∏´‡∏°‡πà] ‡πÅ‡∏õ‡∏•‡∏á String (‡πÄ‡∏ä‡πà‡∏ô "U1,U2") ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Array (‡πÄ‡∏ä‡πà‡∏ô ["U1", "U2"])
  const idArray = idString.split(',').map(id => id.trim()).filter(id => id.length > 0);
  
  if (idArray.length === 0) {
    Logger.log('‚ùå Error: LINE_TO_ID property is set but contains no valid IDs.');
    return;
  }

  // 4. [‡πÉ‡∏´‡∏°‡πà] ‡∏Å‡∏≥‡∏´‡∏ô‡∏î URL ‡πÄ‡∏õ‡πá‡∏ô "multicast"
  const LINE_API_URL = 'https://api.line.me/v2/bot/message/multicast';

  // 5. [‡πÉ‡∏´‡∏°‡πà] ‡∏™‡∏£‡πâ‡∏≤‡∏á Payload ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ idArray
  const payload = {
    to: idArray, // üëà ‡πÉ‡∏ä‡πâ Array ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß
    messages: [
      {
        type: 'text',
        text: message
      }
    ]
  };

  // 6. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Options (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
  const options = {
    method: 'post',
    contentType: 'application/json',
    headers: {
      Authorization: 'Bearer ' + CHANNEL_TOKEN
    },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  // 7. ‡∏™‡πà‡∏á Request (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
  try {
    const response = UrlFetchApp.fetch(LINE_API_URL, options);
    const responseCode = response.getResponseCode();
    const responseBody = response.getContentText();

    if (responseCode === 200) {
      Logger.log('‚úÖ LINE multicast message sent successfully to ' + idArray.length + ' users.');
    } else {
      // ‡∏ñ‡πâ‡∏≤ Error 400 ‡∏≠‡∏≤‡∏à‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏°‡∏µ User ID ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
      Logger.log(`‚ùå Failed to send LINE multicast. Code: ${responseCode}. Body: ${responseBody}`);
    }
  } catch (e) {
    Logger.log('‚ùå Exception during UrlFetchApp: ' + e.message);
  }
}

// ==========================================
// ‚è∞ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Auto Check-Out ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô
// ==========================================

function runAutoCheckOutJob() {
  const book = SpreadsheetApp.openById(SHEET_ID);
  const sheet = book.getSheetByName(ATTENDANCE_SHEET_NAME);
  
  // 1. ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô" (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏£‡∏±‡∏ô job ‡∏ô‡∏µ‡πâ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô)
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1); // ‡∏¢‡πâ‡∏≠‡∏ô‡πÑ‡∏õ 1 ‡∏ß‡∏±‡∏ô
  const yesterdayStr = Utilities.formatDate(yesterday, 'GMT+7', 'yyyy-MM-dd');
  
  console.log("Running Auto Check-Out for date: " + yesterdayStr);

  const data = sheet.getDataRange().getValues();
  const headers = data.shift(); // ‡πÄ‡∏≠‡∏≤‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏≠‡∏Å

  // ‡∏´‡∏≤ index ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ
  const colIndexes = {
    empId: headers.indexOf('empId'),
    date: headers.indexOf('date'),
    checkIn: headers.indexOf('checkIn'),
    checkOut: headers.indexOf('checkOut'),
    status: headers.indexOf('status'),
    workHours: headers.indexOf('workHours'),
    otHours: headers.indexOf('otHours'),
    totalHours: headers.indexOf('totalHours'),
    totalHours_HHMM: headers.indexOf('totalHours_HHMM'),
    checkOut_type: headers.indexOf('checkOut_type'),
    checkOut_reason: headers.indexOf('checkOut_reason')
  };

  // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß
  data.forEach((row, index) => {
    const rowIndex = index + 2; // ‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô Sheet ‡∏à‡∏£‡∏¥‡∏á (data ‡πÄ‡∏£‡∏¥‡πà‡∏° 0, header 1)
    
    // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô String ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
    let rowDateStr = '';
    if (row[colIndexes.date] instanceof Date) {
      rowDateStr = Utilities.formatDate(row[colIndexes.date], 'GMT+7', 'yyyy-MM-dd');
    } else {
      rowDateStr = String(row[colIndexes.date]);
    }

    const checkInTime = row[colIndexes.checkIn];
    const checkOutTime = row[colIndexes.checkOut];

    // üéØ ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô + ‡∏°‡∏µ CheckIn + ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ CheckOut
    if (rowDateStr === yesterdayStr && checkInTime && !checkOutTime) {
      
      // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤ Check-Out ‡πÉ‡∏´‡∏°‡πà (CheckIn + 9 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)
      const newCheckOutTime = addNineHours(checkInTime);
      
      // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
      const stats = calculateStatsServer(checkInTime, newCheckOutTime);

      // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Sheet
      sheet.getRange(rowIndex, colIndexes.checkOut + 1).setValue("'" + newCheckOutTime); // ‡πÉ‡∏™‡πà ' ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Text
      sheet.getRange(rowIndex, colIndexes.status + 1).setValue('‡∏•‡∏∑‡∏° Check-Out');
      
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
      if (colIndexes.workHours > -1) sheet.getRange(rowIndex, colIndexes.workHours + 1).setValue(stats.workHours);
      if (colIndexes.otHours > -1) sheet.getRange(rowIndex, colIndexes.otHours + 1).setValue(stats.otHours);
      if (colIndexes.totalHours > -1) sheet.getRange(rowIndex, colIndexes.totalHours + 1).setValue(stats.totalHours);
      if (colIndexes.totalHours_HHMM > -1) sheet.getRange(rowIndex, colIndexes.totalHours_HHMM + 1).setValue(stats.totalHours_HHMM);

      // ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏° (Optional)
      if (colIndexes.checkOut_type > -1) sheet.getRange(rowIndex, colIndexes.checkOut_type + 1).setValue('‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥');
      if (colIndexes.checkOut_reason > -1) sheet.getRange(rowIndex, colIndexes.checkOut_reason + 1).setValue('Auto Check-out (+9 hrs)');

      console.log(`Auto Check-Out User: ${row[colIndexes.empId]} | Time: ${newCheckOutTime}`);
    }
  });
}

// --- Helper: ‡∏ö‡∏ß‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ 9 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ---
function addNineHours(timeStr) {
  // timeStr format "HH:mm" e.g., "09:10"
  if (!timeStr || typeof timeStr !== 'string') return "18:00"; // fallback
  
  const parts = timeStr.split(':');
  let hours = parseInt(parts[0], 10);
  let mins = parseInt(parts[1], 10);
  
  hours += 9; // ‡∏ö‡∏ß‡∏Å 9 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
  
  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 24 ‡∏ä‡∏°. ‡πÉ‡∏´‡πâ‡∏ß‡∏ô‡∏Å‡∏•‡∏±‡∏ö (‡πÅ‡∏ï‡πà‡∏õ‡∏Å‡∏ï‡∏¥‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ô‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡∏ô‡∏±‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ)
  if (hours >= 24) hours -= 24;
  
  return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
}

// --- Helper: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡∏ö Logic ‡∏ù‡∏±‡πà‡∏á Client) ---
function calculateStatsServer(checkIn, checkOut) {
  const [inH, inM] = checkIn.split(':').map(Number);
  const [outH, outM] = checkOut.split(':').map(Number);

  let totalMins = (outH * 60 + outM) - (inH * 60 + inM);
  if (totalMins < 0) totalMins += 24 * 60; // ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô

  const totalDecimal = totalMins / 60;
  
  // Logic: Work=Max 8, OT=‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô
  const workHours = Math.min(totalDecimal, 8.0);
  const otHours = Math.max(0, totalDecimal - 8.0);
  
  // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô HH.MM
  const displayMins = Math.round(totalDecimal * 60);
  const h = Math.floor(displayMins / 60);
  const m = displayMins % 60;
  const hhmm = `${h}.${String(m).padStart(2, '0')}`;

  return {
    workHours: parseFloat(workHours.toFixed(2)),
    otHours: parseFloat(otHours.toFixed(2)),
    totalHours: parseFloat(totalDecimal.toFixed(2)),
    totalHours_HHMM: hhmm
  };
}